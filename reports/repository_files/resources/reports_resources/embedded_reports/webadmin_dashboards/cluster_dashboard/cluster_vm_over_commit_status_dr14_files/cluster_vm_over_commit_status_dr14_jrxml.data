<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="cluster_vm_over_commit_status_dr14" language="groovy" pageWidth="534" pageHeight="35" whenNoDataType="AllSectionsNoDetail" columnWidth="534" leftMargin="0" rightMargin="0" topMargin="0" bottomMargin="0" resourceBundle="ovirt_reports_bundle" whenResourceMissingType="Error" uuid="04074979-cae0-4e58-8a21-3803e1864fec">
    <property name="ireport.zoom" value="1.0"/>
    <property name="ireport.x" value="0"/>
    <property name="ireport.y" value="0"/>
    <property name="ireport.jasperserver.reportUnit" value="/reports_resources/embedded_reports/webadmin_dashboards/cluster_dashboard/cluster_vm_over_commit_status_dr14"/>
    <property name="ireport.jasperserver.url" value="http://localhost:8080/jasperserver-pro/services/repository"/>
    <parameter name="P_Cluster_ID" class="java.lang.String">
        <defaultValueExpression><![CDATA["00000000-0000-0000-0000-000000000000"]]></defaultValueExpression>
    </parameter>
    <queryString>
        <![CDATA[-- Hosts CPU Cores Total and Hosts Physical Memory Total
SELECT 'avg_host' as entity,
       SUM(coalesce(v3_0_host_configuration_view.number_of_cores,0)*minutes_in_status)/SUM(minutes_in_status) AS cpu_cores,
       SUM(coalesce(v3_0_host_configuration_view.memory_size_mb,0)*minutes_in_status)/SUM(minutes_in_status) AS mem_avg
FROM v3_0_host_samples_history_view
     INNER JOIN v3_0_host_configuration_view
         ON (v3_0_host_configuration_view.history_id = v3_0_host_samples_history_view.host_configuration_version)
     INNER JOIN v3_0_latest_host_configuration_view a
         ON (a.host_id = v3_0_host_samples_history_view.host_id)
WHERE v3_0_host_samples_history_view.host_status = 1
      AND a.cluster_id = cast($P{P_Cluster_ID} as UUID)
UNION ALL
-- vms CPU Cores Total and vms Physical Memory Total
SELECT 'total_avg_vms' as entity,
       SUM(nested_query.cpu_cores) as cpu_cores_total,
       SUM(nested_query.mem_avg) as mem_avg_total
FROM  (SELECT a.vm_id,
        SUM(coalesce(v3_0_vm_configuration_view.cpu_per_socket,0)*coalesce(v3_0_vm_configuration_view.number_of_sockets,0)*minutes_in_status)/SUM(minutes_in_status) AS cpu_cores,
        SUM(coalesce(v3_0_vm_configuration_view.memory_size_mb,0)*minutes_in_status)/SUM(minutes_in_status) AS mem_avg
       FROM v3_0_vm_samples_history_view
      INNER JOIN v3_0_vm_configuration_view
          ON (v3_0_vm_configuration_view.history_id = v3_0_vm_samples_history_view.vm_configuration_version)
      INNER JOIN v3_0_latest_vm_configuration_view a
          ON (a.vm_id = v3_0_vm_samples_history_view.vm_id)
       WHERE v3_0_vm_samples_history_view.vm_status = 1
             AND a.cluster_id = cast($P{P_Cluster_ID} as uuid)
       GROUP BY a.vm_id) as nested_query]]>
    </queryString>
    <field name="entity" class="java.lang.String"/>
    <field name="cpu_cores" class="java.math.BigDecimal"/>
    <field name="mem_avg" class="java.math.BigDecimal"/>
    <variable name="vm_avg_total_vcores" class="java.math.BigDecimal">
        <variableExpression><![CDATA[$F{entity} == "total_avg_vms" ? $F{cpu_cores} : $V{vm_avg_total_vcores}]]></variableExpression>
    </variable>
    <variable name="vm_avg_total_mem" class="java.math.BigDecimal">
        <variableExpression><![CDATA[$F{entity} == "total_avg_vms" ? $F{mem_avg} : $V{vm_avg_total_mem}]]></variableExpression>
    </variable>
    <variable name="host_avg_total_cores" class="java.math.BigDecimal">
        <variableExpression><![CDATA[$F{entity} == "avg_host" ? $F{cpu_cores} : $V{host_avg_total_cores}]]></variableExpression>
    </variable>
    <variable name="host_avg_total_mem" class="java.math.BigDecimal">
        <variableExpression><![CDATA[$F{entity} == "avg_host" ? $F{mem_avg} : $V{host_avg_total_mem}]]></variableExpression>
    </variable>
    <summary>
        <band height="35" splitType="Stretch">
            <textField>
                <reportElement uuid="8765321d-b97f-4e6e-9ce4-7c24bf500622" x="0" y="0" width="387" height="35" forecolor="#333333"/>
                <textElement verticalAlignment="Middle" markup="html">
                    <font fontName="DejaVu Sans" size="16"/>
                </textElement>
                <textFieldExpression><![CDATA[$R{dr14.text} + ":"]]></textFieldExpression>
                <hyperlinkTooltipExpression><![CDATA["Calculates hosts' CPUs number and memory size averages and running virtual machines' total vCPUs number and total memory size averages. Displays check mark if hosts' memory available is more than three times less then committed to running virtual machines and hosts' CPUs are more than two times less than the committed running virtual machines vCPUs, otherwise displays X mark.\nThis query is calculated from the hosts' and virtual machines' statistics samples views for the selected cluster."]]></hyperlinkTooltipExpression>
            </textField>
            <image evaluationTime="Report">
                <reportElement uuid="3f908c13-bf69-4b6b-86f2-e6ceb270acc7" x="387" y="7" width="17" height="15">
                    <printWhenExpression><![CDATA[($V{vm_avg_total_vcores} != null && $V{vm_avg_total_mem} != null && $V{host_avg_total_cores} != null && $V{host_avg_total_mem} != null) &&
(($V{vm_avg_total_vcores}/2 >= $V{host_avg_total_cores}) || ($V{vm_avg_total_mem}/3 >= $V{host_avg_total_mem}))]]></printWhenExpression>
                </reportElement>
                <imageExpression><![CDATA["repo:/reports_resources/x-mark.jpg"]]></imageExpression>
                <hyperlinkTooltipExpression><![CDATA["Calculates hosts' CPUs number and memory size averages and running virtual machines' total vCPUs number and total memory size averages. Displays check mark if hosts' memory available is more than three times less then committed to running virtual machines and hosts' CPUs are more than two times less than the committed running virtual machines vCPUs, otherwise displays X mark.\nThis query is calculated from the hosts' and virtual machines' statistics samples views for the selected cluster."]]></hyperlinkTooltipExpression>
            </image>
            <image evaluationTime="Report">
                <reportElement uuid="9cea8b7f-f5fb-4655-8f1f-b751528b6897" x="387" y="7" width="17" height="15">
                    <printWhenExpression><![CDATA[($V{vm_avg_total_vcores} == null || $V{vm_avg_total_mem} == null || $V{host_avg_total_cores} == null || $V{host_avg_total_mem} == null) ||
(($V{vm_avg_total_vcores}/2 < $V{host_avg_total_cores}) && ($V{vm_avg_total_mem}/3 < $V{host_avg_total_mem}))]]></printWhenExpression>
                </reportElement>
                <imageExpression><![CDATA["repo:/reports_resources/check-mark.jpg"]]></imageExpression>
                <hyperlinkTooltipExpression><![CDATA["Calculates hosts' CPUs number and memory size averages and running virtual machines' total vCPUs number and total memory size averages. Displays check mark if hosts' memory available is more than three times less then committed to running virtual machines and hosts' CPUs are more than two times less than the committed running virtual machines vCPUs, otherwise displays X mark.\nThis query is calculated from the hosts' and virtual machines' statistics samples views for the selected cluster."]]></hyperlinkTooltipExpression>
            </image>
        </band>
    </summary>
</jasperReport>
