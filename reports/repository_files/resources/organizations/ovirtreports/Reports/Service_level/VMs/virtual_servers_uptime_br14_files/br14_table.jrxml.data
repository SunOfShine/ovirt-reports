<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="Test_001" language="groovy" pageWidth="584" pageHeight="832" columnWidth="584" leftMargin="0" rightMargin="0" topMargin="0" bottomMargin="0">
	<property name="ireport.jasperserver.reportUnit" value="/temp/Test_002_1_1_1_4"/>
	<property name="ireport.jasperserver.url" value="http://192.168.10.120:8080/jasperserver-pro/services/repository"/>
	<property name="ireport.zoom" value="1.0"/>
	<property name="ireport.x" value="0"/>
	<property name="ireport.y" value="0"/>
	<style name="Crosstab Data Text" isDefault="false" hAlign="Center"/>
	<style name="Line Style" isDefault="false">
		<conditionalStyle>
			<conditionExpression><![CDATA[($V{REPORT_COUNT} % 2) == 0]]></conditionExpression>
			<style isDefault="false" style="Line Style" mode="Opaque" backcolor="#EFF3FF"/>
		</conditionalStyle>
	</style>
	<parameter name="P_DataCenter_ID" class="java.lang.String">
		<parameterDescription><![CDATA[Select a DataCenter]]></parameterDescription>
		<defaultValueExpression><![CDATA["00000000-0000-0000-0000-000000000000"]]></defaultValueExpression>
	</parameter>
	<parameter name="P_Cluster_ID" class="java.lang.String">
		<parameterDescription><![CDATA[Select a Cluster]]></parameterDescription>
		<defaultValueExpression><![CDATA["00000000-0000-0000-0000-000000000000"]]></defaultValueExpression>
	</parameter>
	<parameter name="P_Period" class="java.lang.String">
		<parameterDescription><![CDATA[Period]]></parameterDescription>
	</parameter>
	<parameter name="P_Dates" class="java.lang.String">
		<parameterDescription><![CDATA[Enter Period Month]]></parameterDescription>
	</parameter>
	<parameter name="REPORT_NAME" class="java.lang.String" isForPrompting="false"/>
	<parameter name="P_VM_Type" class="java.lang.Integer"/>
	<parameter name="P_Start_Date" class="java.lang.String">
		<defaultValueExpression><![CDATA["01/01/2000"]]></defaultValueExpression>
	</parameter>
	<parameter name="P_End_Date" class="java.lang.String">
		<defaultValueExpression><![CDATA["01/01/2000"]]></defaultValueExpression>
	</parameter>
	<parameter name="Active_VMs" class="java.lang.String">
		<defaultValueExpression><![CDATA["AND delete_date IS NULL"]]></defaultValueExpression>
	</parameter>
	<queryString>
		<![CDATA[SELECT
      v3_0_vm_configuration_view.cluster_id
       ,v3_0_vm_configuration_view.vm_id
       ,v3_0_vm_configuration_view.vm_name
       ,CASE
		WHEN v3_0_vm_configuration_view.delete_date IS NULL THEN 0
		ELSE 1
	END as is_deleted
       ,SUM(CASE WHEN v3_0_vm_daily_history_view.vm_status in (3,0) THEN coalesce(v3_0_vm_daily_history_view.minutes_in_status,0) ELSE 0 END)AS unplanned_downtime_mins
       ,SUM(CASE WHEN v3_0_vm_daily_history_view.vm_status = 1 THEN coalesce(v3_0_vm_daily_history_view.minutes_in_status,0) ELSE 0 END)AS uptime_mins
       ,Sum(v3_0_vm_daily_history_view.minutes_in_status) as total

FROM v3_0_vm_daily_history_view
INNER JOIN v3_0_vm_configuration_view
     ON (v3_0_vm_configuration_view.vm_id = v3_0_vm_daily_history_view.vm_id)
WHERE
 v3_0_vm_configuration_view.cluster_id in (SELECT cluster_id
					     FROM v3_0_cluster_configuration_view
					     Where datacenter_id = cast($P{P_DataCenter_ID} as uuid))
AND v3_0_vm_configuration_view.cluster_id = CASE $P{P_Cluster_ID}
				           WHEN NULL THEN v3_0_vm_configuration_view.cluster_id
					   WHEN '11111111-1111-1111-1111-111111111111' THEN v3_0_vm_configuration_view.cluster_id
					   ELSE cast($P{P_Cluster_ID} as uuid)
					   END
AND v3_0_vm_configuration_view.vm_type = 1
AND high_availability = TRUE
AND history_datetime >= cast($P{P_Start_Date} as timestamp)
AND history_datetime < cast($P{P_End_Date} as date) + interval '1 day'
AND v3_0_vm_configuration_view.history_id in (SELECT max(a.history_id)
					      FROM v3_0_vm_configuration_view a
					      WHERE v3_0_vm_configuration_view.vm_id = a.vm_id)
$P!{Active_VMs}
GROUP BY  v3_0_vm_configuration_view.cluster_id
	  ,v3_0_vm_configuration_view.vm_id
	  ,v3_0_vm_configuration_view.vm_name
	  ,CASE
		WHEN v3_0_vm_configuration_view.delete_date IS NULL THEN 0
		ELSE 1
	  END
HAVING SUM(CASE WHEN v3_0_vm_daily_history_view.vm_status = 1 THEN coalesce(v3_0_vm_daily_history_view.minutes_in_status,0) ELSE 0 END) > 0
ORDER BY is_deleted ASC, cast(SUM(CASE WHEN v3_0_vm_daily_history_view.vm_status in (3,0) THEN coalesce(v3_0_vm_daily_history_view.minutes_in_status,0) ELSE 0 END) as float)/cast(SUM(coalesce(v3_0_vm_daily_history_view.minutes_in_status,0)) as float) DESC]]>
	</queryString>
	<field name="cluster_id" class="java.lang.Object">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="vm_id" class="java.lang.Object">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="vm_name" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="is_deleted" class="java.lang.Integer">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="unplanned_downtime_mins" class="java.math.BigDecimal">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="uptime_mins" class="java.math.BigDecimal">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="total" class="java.math.BigDecimal">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<group name="Data Center">
		<groupExpression><![CDATA[$P{P_DataCenter_ID}]]></groupExpression>
		<groupHeader>
			<band height="40">
				<staticText>
					<reportElement mode="Transparent" x="0" y="0" width="491" height="20" forecolor="#3A5E75"/>
					<textElement>
						<font fontName="DejaVu Sans" size="13" isBold="true" isUnderline="false"/>
					</textElement>
					<text><![CDATA[Downtime Breakdown of Cluster's High Availability Virtual Servers ]]></text>
				</staticText>
				<frame>
					<reportElement mode="Opaque" x="0" y="20" width="584" height="20" backcolor="#D8E2FF"/>
					<staticText>
						<reportElement mode="Opaque" x="12" y="0" width="302" height="20" backcolor="#D8E2FF"/>
						<textElement verticalAlignment="Middle">
							<font fontName="DejaVu Sans" size="11" isBold="true"/>
						</textElement>
						<text><![CDATA[VM Name 			]]></text>
					</staticText>
					<staticText>
						<reportElement mode="Opaque" x="314" y="0" width="114" height="20" backcolor="#D8E2FF"/>
						<textElement textAlignment="Center" verticalAlignment="Middle">
							<font fontName="DejaVu Sans" size="11" isBold="true"/>
						</textElement>
						<text><![CDATA[Uptime]]></text>
					</staticText>
					<staticText>
						<reportElement mode="Opaque" x="428" y="0" width="156" height="20" backcolor="#D8E2FF"/>
						<textElement textAlignment="Center" verticalAlignment="Middle">
							<font fontName="DejaVu Sans" size="11" isBold="true"/>
						</textElement>
						<text><![CDATA[Unplanned Downtime]]></text>
					</staticText>
				</frame>
			</band>
		</groupHeader>
	</group>
	<title>
		<band height="1" splitType="Stretch"/>
	</title>
	<pageHeader>
		<band splitType="Prevent"/>
	</pageHeader>
	<columnHeader>
		<band splitType="Stretch"/>
	</columnHeader>
	<detail>
		<band height="18" splitType="Stretch">
			<frame>
				<reportElement style="Line Style" x="0" y="0" width="584" height="18"/>
				<textField pattern="#,##0">
					<reportElement x="12" y="0" width="302" height="18"/>
					<textElement verticalAlignment="Middle">
						<font fontName="DejaVu Sans"/>
					</textElement>
					<textFieldExpression class="java.lang.String"><![CDATA[$F{vm_name}]]></textFieldExpression>
					<hyperlinkTooltipExpression><![CDATA[$F{vm_name}]]></hyperlinkTooltipExpression>
				</textField>
				<frame>
					<reportElement x="314" y="0" width="114" height="18"/>
					<textField>
						<reportElement x="0" y="0" width="24" height="18">
							<printWhenExpression><![CDATA[((($F{uptime_mins}/60)/24).intValue()) != 0]]></printWhenExpression>
						</reportElement>
						<textElement textAlignment="Right" verticalAlignment="Middle">
							<font fontName="DejaVu Sans"/>
						</textElement>
						<textFieldExpression class="java.lang.String"><![CDATA[((($F{uptime_mins}/60)/24).intValue()).toString() + "d"]]></textFieldExpression>
					</textField>
					<textField>
						<reportElement x="26" y="0" width="20" height="18">
							<printWhenExpression><![CDATA[((($F{uptime_mins}/60)/24).intValue()) != 0 || (($F{uptime_mins}/60).intValue()-(((($F{uptime_mins}/60)/24).intValue())*24)) != 0]]></printWhenExpression>
						</reportElement>
						<textElement textAlignment="Right" verticalAlignment="Middle">
							<font fontName="DejaVu Sans"/>
						</textElement>
						<textFieldExpression class="java.lang.String"><![CDATA[(($F{uptime_mins}/60).intValue()-(((($F{uptime_mins}/60)/24).intValue())*24)).toString() + "h"]]></textFieldExpression>
					</textField>
					<textField>
						<reportElement x="48" y="0" width="24" height="18"/>
						<textElement textAlignment="Right" verticalAlignment="Middle">
							<font fontName="DejaVu Sans"/>
						</textElement>
						<textFieldExpression class="java.lang.String"><![CDATA[($F{uptime_mins} - ((($F{uptime_mins}/60).intValue()-(((($F{uptime_mins}/60)/24).intValue())*24))*60)-(((($F{uptime_mins}/60)/24).intValue())*60*24)).intValue().toString() + "m"]]></textFieldExpression>
					</textField>
					<textField isBlankWhenNull="false">
						<reportElement x="74" y="0" width="40" height="18"/>
						<textElement textAlignment="Right" verticalAlignment="Middle">
							<font fontName="DejaVu Sans" isBold="false"/>
						</textElement>
						<textFieldExpression class="java.lang.String"><![CDATA["(" + (100-(($F{unplanned_downtime_mins}/$F{total})*100).intValue()).toString() + "%)"]]></textFieldExpression>
					</textField>
				</frame>
				<frame>
					<reportElement x="449" y="0" width="114" height="18"/>
					<textField>
						<reportElement x="0" y="0" width="24" height="18">
							<printWhenExpression><![CDATA[((($F{unplanned_downtime_mins}/60)/24).intValue()) != 0]]></printWhenExpression>
						</reportElement>
						<textElement textAlignment="Right" verticalAlignment="Middle">
							<font fontName="DejaVu Sans"/>
						</textElement>
						<textFieldExpression class="java.lang.String"><![CDATA[((($F{unplanned_downtime_mins}/60)/24).intValue()).toString() + "d"]]></textFieldExpression>
					</textField>
					<textField>
						<reportElement x="26" y="0" width="20" height="18">
							<printWhenExpression><![CDATA[((($F{unplanned_downtime_mins}/60)/24).intValue()) != 0 || (($F{unplanned_downtime_mins}/60).intValue()-(((($F{unplanned_downtime_mins}/60)/24).intValue())*24)) != 0]]></printWhenExpression>
						</reportElement>
						<textElement textAlignment="Right" verticalAlignment="Middle">
							<font fontName="DejaVu Sans"/>
						</textElement>
						<textFieldExpression class="java.lang.String"><![CDATA[(($F{unplanned_downtime_mins}/60).intValue()-(((($F{unplanned_downtime_mins}/60)/24).intValue())*24)).toString() + "h"]]></textFieldExpression>
					</textField>
					<textField>
						<reportElement x="48" y="0" width="24" height="18"/>
						<textElement textAlignment="Right" verticalAlignment="Middle">
							<font fontName="DejaVu Sans"/>
						</textElement>
						<textFieldExpression class="java.lang.String"><![CDATA[($F{unplanned_downtime_mins} - ((($F{unplanned_downtime_mins}/60).intValue()-(((($F{unplanned_downtime_mins}/60)/24).intValue())*24))*60)-(((($F{unplanned_downtime_mins}/60)/24).intValue())*60*24)).intValue().toString() + "m"]]></textFieldExpression>
					</textField>
					<textField pattern="">
						<reportElement x="74" y="0" width="40" height="18"/>
						<textElement textAlignment="Right" verticalAlignment="Middle">
							<font fontName="DejaVu Sans" isBold="true"/>
						</textElement>
						<textFieldExpression class="java.lang.String"><![CDATA["(" + (($F{unplanned_downtime_mins}/$F{total})*100).intValue().toString() + "%)"]]></textFieldExpression>
					</textField>
				</frame>
				<image>
					<reportElement x="0" y="3" width="10" height="11">
						<printWhenExpression><![CDATA[$F{is_deleted} == 1]]></printWhenExpression>
					</reportElement>
					<imageExpression class="java.lang.String"><![CDATA["repo:/organizations/ovirtreports/Resources/trash-icon"]]></imageExpression>
				</image>
			</frame>
		</band>
	</detail>
</jasperReport>
