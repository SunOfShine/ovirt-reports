<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="BR21" language="groovy" pageWidth="842" pageHeight="595" orientation="Landscape" whenNoDataType="AllSectionsNoDetail" columnWidth="832" leftMargin="5" rightMargin="5" topMargin="5" bottomMargin="5">
	<property name="ireport.jasperserver.reportUnit" value="/organizations/ovirtreports/Reports/Inventory/Storage_Domain_Report_BR21"/>
	<property name="ireport.jasperserver.url" value="http://localhost:8080/jasperserver/services/repository"/>
	<property name="ireport.zoom" value="1.0"/>
	<property name="ireport.x" value="0"/>
	<property name="ireport.y" value="0"/>
	<parameter name="REPORT_NAME" class="java.lang.String" isForPrompting="false"/>
	<parameter name="SUBREPORT_DIR" class="java.lang.String" isForPrompting="false">
		<defaultValueExpression><![CDATA["C:\\Program Files\\jasperserver-pro-3.7\\"]]></defaultValueExpression>
	</parameter>
	<parameter name="P_Period" class="java.lang.String">
		<parameterDescription><![CDATA[Period]]></parameterDescription>
		<defaultValueExpression><![CDATA["Quarterly"]]></defaultValueExpression>
	</parameter>
	<parameter name="P_Dates" class="java.lang.String">
		<parameterDescription><![CDATA[Enter Period Month]]></parameterDescription>
		<defaultValueExpression><![CDATA["April 2019"]]></defaultValueExpression>
	</parameter>
	<parameter name="P_Start_Date" class="java.lang.String">
		<defaultValueExpression><![CDATA["01/01/2000"]]></defaultValueExpression>
	</parameter>
	<parameter name="P_End_Date" class="java.lang.String">
		<defaultValueExpression><![CDATA["01/01/2000"]]></defaultValueExpression>
	</parameter>
	<parameter name="P_DataCenter_ID" class="java.lang.String">
		<parameterDescription><![CDATA[Select a DataCenter]]></parameterDescription>
		<defaultValueExpression><![CDATA["00000000-0000-0000-0000-000000000000"]]></defaultValueExpression>
	</parameter>
	<parameter name="P_Storage_Type" class="java.lang.Integer">
		<defaultValueExpression><![CDATA[12]]></defaultValueExpression>
	</parameter>
	<parameter name="P_StorageDomain_ID" class="java.lang.String">
		<defaultValueExpression><![CDATA["00000000-0000-0000-0000-000000000000"]]></defaultValueExpression>
	</parameter>
	<parameter name="active_storage" class="java.lang.String">
		<defaultValueExpression><![CDATA["AND delete_date IS NULL"]]></defaultValueExpression>
	</parameter>
	<queryString>
		<![CDATA[select distinct the_date, coalesce(storage_domain_name,max(storage_domain_name) over (partition by 1),'') as storage_domain_name, available_disk_size, used_disk_size
FROM (SELECT v3_0_storage_domain_configuration_view.storage_domain_name,
		   history_datetime,
		   AVG(available_disk_size_gb) AS available_disk_size,
		   AVG(used_disk_size_gb) AS used_disk_size
	FROM v3_0_storage_domain_daily_history_view, v3_0_storage_domain_configuration_view
	WHERE v3_0_storage_domain_configuration_view.storage_domain_id = v3_0_storage_domain_daily_history_view.storage_domain_id
		  AND v3_0_storage_domain_daily_history_view.storage_domain_id = CASE $P{P_StorageDomain_ID}
										WHEN NULL THEN null
										WHEN '11111111-1111-1111-1111-111111111111' then null
										ELSE cast($P{P_StorageDomain_ID} as uuid)
									 END
		  AND history_datetime >= cast($P{P_Start_Date} as timestamp)
		  AND history_datetime < cast($P{P_End_Date} as date) + interval '1 day'
		  AND v3_0_storage_domain_configuration_view.history_id = (SELECT max(a.history_id)
									   FROM v3_0_storage_domain_configuration_view a
									   WHERE a.storage_domain_id = v3_0_storage_domain_configuration_view.storage_domain_id)
	GROUP BY v3_0_storage_domain_configuration_view.storage_domain_name,
		   history_datetime) a right outer join calendar b on (a.history_datetime = b.the_date)
where the_date >= cast($P{P_Start_Date} as date)
      AND the_date < cast($P{P_End_Date} as date) + interval '1 day'
order by the_date]]>
	</queryString>
	<field name="the_date" class="java.sql.Date">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="storage_domain_name" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="available_disk_size" class="java.math.BigDecimal">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="used_disk_size" class="java.math.BigDecimal">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<title>
		<band height="136">
			<subreport>
				<reportElement x="1" y="45" width="830" height="89"/>
				<subreportParameter name="P_Period">
					<subreportParameterExpression><![CDATA[$P{P_Period}]]></subreportParameterExpression>
				</subreportParameter>
				<subreportParameter name="P_DataCenter_ID">
					<subreportParameterExpression><![CDATA[$P{P_DataCenter_ID}]]></subreportParameterExpression>
				</subreportParameter>
				<subreportParameter name="P_Start_Date">
					<subreportParameterExpression><![CDATA[$P{P_Start_Date}]]></subreportParameterExpression>
				</subreportParameter>
				<subreportParameter name="P_StorageDomain_ID">
					<subreportParameterExpression><![CDATA[$P{P_StorageDomain_ID}]]></subreportParameterExpression>
				</subreportParameter>
				<subreportParameter name="P_Dates">
					<subreportParameterExpression><![CDATA[$P{P_Dates}]]></subreportParameterExpression>
				</subreportParameter>
				<subreportParameter name="P_End_Date">
					<subreportParameterExpression><![CDATA[$P{P_End_Date}]]></subreportParameterExpression>
				</subreportParameter>
				<subreportParameter name="P_Storage_Type">
					<subreportParameterExpression><![CDATA[$P{P_Storage_Type}]]></subreportParameterExpression>
				</subreportParameter>
				<connectionExpression><![CDATA[$P{REPORT_CONNECTION}]]></connectionExpression>
				<subreportExpression><![CDATA["repo:full details br21.jrxml"]]></subreportExpression>
			</subreport>
			<textField pattern="">
				<reportElement x="583" y="27" width="249" height="15"/>
				<textElement textAlignment="Right">
					<font fontName="DejaVu Sans" size="11" isBold="false"/>
				</textElement>
				<textFieldExpression><![CDATA[DateFormat.getDateInstance().format(new Date())]]></textFieldExpression>
			</textField>
			<line>
				<reportElement x="0" y="43" width="832" height="1"/>
			</line>
			<image>
				<reportElement x="0" y="0" width="228" height="42"/>
				<imageExpression><![CDATA["repo:ovirt-icon"]]></imageExpression>
			</image>
		</band>
	</title>
	<columnHeader>
		<band height="272">
			<timeSeriesChart>
				<chart evaluationTime="Report" customizerClass="com.ovirt.reports.jasper.FullNameTimelineChartCustomizer" theme="ReportsLineBarChartTheme">
					<reportElement mode="Opaque" x="0" y="1" width="830" height="270"/>
					<box>
						<pen lineWidth="1.0" lineColor="#3C617F"/>
						<topPen lineWidth="1.0" lineColor="#3C617F"/>
						<leftPen lineWidth="1.0" lineColor="#3C617F"/>
						<bottomPen lineWidth="1.0" lineColor="#3C617F"/>
						<rightPen lineWidth="1.0" lineColor="#3C617F"/>
					</box>
					<chartTitle>
						<font fontName="DejaVu Sans"/>
						<titleExpression><![CDATA["Available Size in Storage Domain Over Time"]]></titleExpression>
					</chartTitle>
					<chartSubtitle/>
					<chartLegend/>
				</chart>
				<timeSeriesDataset>
					<timeSeries>
						<seriesExpression><![CDATA["Available Space"]]></seriesExpression>
						<timePeriodExpression><![CDATA[$F{the_date}]]></timePeriodExpression>
						<valueExpression><![CDATA[$F{available_disk_size}]]></valueExpression>
						<itemHyperlink>
							<hyperlinkTooltipExpression><![CDATA[$F{available_disk_size}.setScale(2, RoundingMode.HALF_UP).toString()]]></hyperlinkTooltipExpression>
						</itemHyperlink>
					</timeSeries>
					<timeSeries>
						<seriesExpression><![CDATA["Used Space"]]></seriesExpression>
						<timePeriodExpression><![CDATA[$F{the_date}]]></timePeriodExpression>
						<valueExpression><![CDATA[$F{used_disk_size}]]></valueExpression>
						<itemHyperlink>
							<hyperlinkTooltipExpression><![CDATA[$F{used_disk_size}.setScale(2, RoundingMode.HALF_UP).toString()]]></hyperlinkTooltipExpression>
						</itemHyperlink>
					</timeSeries>
				</timeSeriesDataset>
				<timeSeriesPlot isShowShapes="false">
					<plot labelRotation="-45.0"/>
					<timeAxisLabelExpression><![CDATA["Date"]]></timeAxisLabelExpression>
					<timeAxisFormat>
						<axisFormat labelColor="#666666">
							<labelFont>
								<font isBold="true"/>
							</labelFont>
						</axisFormat>
					</timeAxisFormat>
					<valueAxisLabelExpression><![CDATA["Storage Size (GB)"]]></valueAxisLabelExpression>
					<valueAxisFormat>
						<axisFormat labelColor="#666666">
							<labelFont>
								<font fontName="DejaVu Sans"/>
							</labelFont>
							<tickLabelFont>
								<font fontName="DejaVu Sans"/>
							</tickLabelFont>
						</axisFormat>
					</valueAxisFormat>
				</timeSeriesPlot>
			</timeSeriesChart>
		</band>
	</columnHeader>
	<pageFooter>
		<band height="15" splitType="Stretch">
			<textField>
				<reportElement x="295" y="0" width="116" height="15"/>
				<textElement textAlignment="Right">
					<font fontName="DejaVu Sans"/>
				</textElement>
				<textFieldExpression><![CDATA["Page "+$V{PAGE_NUMBER}+" of"]]></textFieldExpression>
			</textField>
			<textField evaluationTime="Report">
				<reportElement x="411" y="0" width="120" height="15"/>
				<textElement>
					<font fontName="DejaVu Sans"/>
				</textElement>
				<textFieldExpression><![CDATA[" " + $V{PAGE_NUMBER}]]></textFieldExpression>
			</textField>
		</band>
	</pageFooter>
</jasperReport>
