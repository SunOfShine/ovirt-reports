<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="BR17B" language="groovy" pageWidth="358" pageHeight="358" whenNoDataType="AllSectionsNoDetail" columnWidth="358" leftMargin="0" rightMargin="0" topMargin="0" bottomMargin="0">
	<property name="ireport.jasperserver.reportUnit" value="/Resources/embedded_reports/summary_of_host_usage_resources_br17"/>
	<property name="ireport.jasperserver.url" value="http://localhost:8080/ovirt-reports/services/repository"/>
	<property name="ireport.zoom" value="1.0"/>
	<property name="ireport.x" value="0"/>
	<property name="ireport.y" value="0"/>
	<parameter name="P_DataCenter_ID" class="java.lang.String">
		<defaultValueExpression><![CDATA["00000000-0000-0000-0000-000000000000"]]></defaultValueExpression>
	</parameter>
	<parameter name="P_Cluster_ID" class="java.lang.String">
		<defaultValueExpression><![CDATA["00000000-0000-0000-0000-000000000000"]]></defaultValueExpression>
	</parameter>
	<parameter name="P_Period" class="java.lang.String">
		<defaultValueExpression><![CDATA["Quarterly"]]></defaultValueExpression>
	</parameter>
	<parameter name="P_Dates" class="java.lang.String">
		<defaultValueExpression><![CDATA["April 2019"]]></defaultValueExpression>
	</parameter>
	<parameter name="P_Start_Date" class="java.lang.String">
		<defaultValueExpression><![CDATA["01/01/2000"]]></defaultValueExpression>
	</parameter>
	<parameter name="P_End_Date" class="java.lang.String">
		<defaultValueExpression><![CDATA["01/01/2000"]]></defaultValueExpression>
	</parameter>
	<parameter name="active_hosts_select" class="java.lang.String">
		<defaultValueExpression><![CDATA["AND delete_date IS NULL"]]></defaultValueExpression>
	</parameter>
	<queryString>
		<![CDATA[-- Hosts Average Usage Peaks
SELECT
      TBL_DAILY_PEAKS.host_id
      ,host_name
      ,delete_date
      ,cast(AVG(TBL_DAILY_PEAKS.cpu_peak) as int) AS avg_cpu_peak
      ,cast(AVG(TBL_DAILY_PEAKS.mem_peak) as int) AS avg_mem_peak
FROM 	(
	-- Calculation of daily cpu and memory usage peaks
	SELECT	v3_0_host_daily_history_view.host_id,
			host_name,
			history_datetime,
			delete_date,
			MAX(coalesce(max_cpu_usage,0)) as cpu_peak,
			MAX(coalesce(max_memory_usage,0)) as mem_peak
	FROM v3_0_host_daily_history_view
			INNER JOIN v3_0_host_configuration_view
	  				ON (v3_0_host_configuration_view.host_id = v3_0_host_daily_history_view.host_id)
	WHERE
		v3_0_host_configuration_view.cluster_id in (SELECT cluster_id
							    FROM v3_0_cluster_configuration_view
							    Where datacenter_id = cast($P{P_DataCenter_ID} as uuid))
		AND v3_0_host_configuration_view.cluster_id = CASE $P{P_Cluster_ID}
								WHEN NULL THEN v3_0_host_configuration_view.cluster_id
								WHEN '11111111-1111-1111-1111-111111111111' THEN v3_0_host_configuration_view.cluster_id
								ELSE cast($P{P_Cluster_ID} as uuid)
					   		      END
		AND history_datetime >= cast($P{P_Start_Date} as date)
		AND history_datetime < cast($P{P_End_Date} as date) + interval '1 day'
		AND v3_0_host_configuration_view.history_id in (SELECT max(a.history_id)
								FROM v3_0_host_configuration_view a
								WHERE v3_0_host_configuration_view.host_id = a.host_id)
		$P!{active_hosts_select}
	GROUP BY v3_0_host_daily_history_view.host_id, host_name, delete_date, history_datetime
	) AS TBL_DAILY_PEAKS
GROUP BY
      TBL_DAILY_PEAKS.host_id, host_name, delete_date
Order by delete_date DESC, host_id]]>
	</queryString>
	<field name="host_id" class="java.lang.Object"/>
	<field name="host_name" class="java.lang.String"/>
	<field name="delete_date" class="java.sql.Timestamp"/>
	<field name="avg_cpu_peak" class="java.lang.Integer"/>
	<field name="avg_mem_peak" class="java.lang.Integer"/>
	<variable name="avg_cpu_peak_1" class="java.lang.Integer" calculation="Sum">
		<variableExpression><![CDATA[$F{avg_cpu_peak}]]></variableExpression>
	</variable>
	<variable name="avg_mem_peak_1" class="java.lang.Integer" calculation="Sum">
		<variableExpression><![CDATA[$F{avg_mem_peak}]]></variableExpression>
	</variable>
	<variable name="avg_mem_peak_2" class="java.lang.Integer" calculation="Sum">
		<variableExpression><![CDATA[$F{avg_mem_peak}]]></variableExpression>
	</variable>
	<variable name="avg_cpu_peak_2" class="java.lang.Integer" calculation="Sum">
		<variableExpression><![CDATA[$F{avg_cpu_peak}]]></variableExpression>
	</variable>
	<variable name="avg_mem_peak_3" class="java.lang.Integer" calculation="Sum">
		<variableExpression><![CDATA[$F{avg_mem_peak}]]></variableExpression>
	</variable>
	<summary>
		<band height="358" splitType="Stretch">
			<scatterChart>
				<chart isShowLegend="true" evaluationTime="Report" hyperlinkType="ReportExecution" hyperlinkTarget="Blank" customizerClass="com.ovirt.reports.jasper.ScatterChartCustomizer" renderType="draw" theme="ReportsLineBarChartTheme">
					<reportElement x="0" y="0" width="358" height="358"/>
					<box>
						<pen lineWidth="1.0" lineColor="#3C617F"/>
						<topPen lineWidth="1.0" lineColor="#3C617F"/>
						<leftPen lineWidth="2.0" lineColor="#3C617F"/>
						<bottomPen lineWidth="1.0" lineColor="#3C617F"/>
						<rightPen lineWidth="1.0" lineColor="#3C617F"/>
					</box>
					<chartTitle color="#3A5E75">
						<font fontName="DejaVu Sans" isBold="true"/>
						<titleExpression><![CDATA["Summary of Host Usage Resources"]]></titleExpression>
					</chartTitle>
					<chartSubtitle>
						<font fontName="DejaVu Sans"/>
					</chartSubtitle>
					<chartLegend>
						<font fontName="DejaVu Sans"/>
					</chartLegend>
					<hyperlinkParameter name="_report">
						<hyperlinkParameterExpression><![CDATA["/Reports/Executive/summary_of_host_usage_resources_br17"]]></hyperlinkParameterExpression>
					</hyperlinkParameter>
					<hyperlinkParameter name="P_DataCenter_ID">
						<hyperlinkParameterExpression><![CDATA[$P{P_DataCenter_ID}]]></hyperlinkParameterExpression>
					</hyperlinkParameter>
					<hyperlinkParameter name="P_Cluster_ID">
						<hyperlinkParameterExpression><![CDATA[$P{P_Cluster_ID}]]></hyperlinkParameterExpression>
					</hyperlinkParameter>
					<hyperlinkParameter name="P_Period">
						<hyperlinkParameterExpression><![CDATA[$P{P_Period}]]></hyperlinkParameterExpression>
					</hyperlinkParameter>
					<hyperlinkParameter name="P_Dates">
						<hyperlinkParameterExpression><![CDATA[$P{P_Dates}]]></hyperlinkParameterExpression>
					</hyperlinkParameter>
					<hyperlinkParameter name="P_Start_Date">
						<hyperlinkParameterExpression><![CDATA[$P{P_Start_Date}]]></hyperlinkParameterExpression>
					</hyperlinkParameter>
					<hyperlinkParameter name="P_End_Date">
						<hyperlinkParameterExpression><![CDATA[$P{P_End_Date}]]></hyperlinkParameterExpression>
					</hyperlinkParameter>
				</chart>
				<xyDataset>
					<xySeries>
						<seriesExpression><![CDATA[$F{delete_date} == null ? "Active Hosts" : "Deleted Hosts"]]></seriesExpression>
						<xValueExpression><![CDATA[$F{avg_cpu_peak}]]></xValueExpression>
						<yValueExpression><![CDATA[$F{avg_mem_peak}]]></yValueExpression>
						<itemHyperlink>
							<hyperlinkTooltipExpression><![CDATA[$F{host_name} + " (CPU: " + $F{avg_cpu_peak}.toString() + "%, Memory: " + $F{avg_mem_peak}.toString() + "%)"]]></hyperlinkTooltipExpression>
						</itemHyperlink>
					</xySeries>
				</xyDataset>
				<scatterPlot isShowLines="false">
					<plot/>
					<xAxisLabelExpression><![CDATA["CPU Usage %"]]></xAxisLabelExpression>
					<xAxisFormat>
						<axisFormat labelColor="#666666">
							<labelFont>
								<font fontName="DejaVu Sans"/>
							</labelFont>
							<tickLabelFont>
								<font fontName="DejaVu Sans"/>
							</tickLabelFont>
						</axisFormat>
					</xAxisFormat>
					<yAxisLabelExpression><![CDATA["Memory Usage %"]]></yAxisLabelExpression>
					<yAxisFormat>
						<axisFormat labelColor="#666666">
							<labelFont>
								<font fontName="DejaVu Sans"/>
							</labelFont>
							<tickLabelFont>
								<font fontName="DejaVu Sans"/>
							</tickLabelFont>
						</axisFormat>
					</yAxisFormat>
					<domainAxisMinValueExpression><![CDATA[0]]></domainAxisMinValueExpression>
					<domainAxisMaxValueExpression><![CDATA[100]]></domainAxisMaxValueExpression>
					<rangeAxisMinValueExpression><![CDATA[0]]></rangeAxisMinValueExpression>
					<rangeAxisMaxValueExpression><![CDATA[100]]></rangeAxisMaxValueExpression>
				</scatterPlot>
			</scatterChart>
		</band>
	</summary>
</jasperReport>
