<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="BR18A" language="groovy" pageWidth="540" pageHeight="585" orientation="Landscape" whenNoDataType="AllSectionsNoDetail" columnWidth="540" leftMargin="0" rightMargin="0" topMargin="0" bottomMargin="0" resourceBundle="ovirt_reports_bundle" whenResourceMissingType="Error">
	<property name="ireport.jasperserver.reportUnit" value="/organizations/ovirtreports/Resources/embedded_reports/active_entities_by_os_BR18A"/>
	<property name="ireport.jasperserver.url" value="http://localhost:8080/jasperserver/services/repository"/>
	<property name="ireport.zoom" value="1.0"/>
	<property name="ireport.x" value="0"/>
	<property name="ireport.y" value="0"/>
	<style name="style1">
		<conditionalStyle>
			<conditionExpression><![CDATA[($V{Date_group} % 2) == 0]]></conditionExpression>
			<style mode="Opaque" backcolor="#F2F3F9"/>
		</conditionalStyle>
	</style>
	<parameter name="P_DataCenter_ID" class="java.lang.String">
		<parameterDescription><![CDATA[Select a DataCenter]]></parameterDescription>
		<defaultValueExpression><![CDATA["00000000-0000-0000-0000-000000000000"]]></defaultValueExpression>
	</parameter>
	<parameter name="P_Cluster_ID" class="java.lang.String">
		<parameterDescription><![CDATA[Select a Cluster]]></parameterDescription>
		<defaultValueExpression><![CDATA["00000000-0000-0000-0000-000000000000"]]></defaultValueExpression>
	</parameter>
	<parameter name="P_Period" class="java.lang.String">
		<parameterDescription><![CDATA[Period]]></parameterDescription>
		<defaultValueExpression><![CDATA["Quarterly"]]></defaultValueExpression>
	</parameter>
	<parameter name="P_Dates" class="java.lang.String">
		<parameterDescription><![CDATA[Enter Period Month]]></parameterDescription>
		<defaultValueExpression><![CDATA["April 2019"]]></defaultValueExpression>
	</parameter>
	<parameter name="REPORT_NAME" class="java.lang.String" isForPrompting="false"/>
	<parameter name="SUBREPORT_DIR" class="java.lang.String" isForPrompting="false">
		<defaultValueExpression><![CDATA["C:\\Program Files\\jasperserver-pro-3.7\\"]]></defaultValueExpression>
	</parameter>
	<parameter name="P_Start_Date" class="java.lang.String">
		<defaultValueExpression><![CDATA["2000-01-01"]]></defaultValueExpression>
	</parameter>
	<parameter name="P_End_Date" class="java.lang.String">
		<defaultValueExpression><![CDATA["2000-01-01"]]></defaultValueExpression>
	</parameter>
	<parameter name="Active_VMs" class="java.lang.String">
		<defaultValueExpression><![CDATA["AND delete_date IS NULL"]]></defaultValueExpression>
	</parameter>
	<queryString>
		<![CDATA[select distinct the_date, coalesce(os_name,max(os_name) over (partition by 1),'') as os_name, vm_count
FROM (SELECT (CASE
		WHEN UPPER(coalesce(enum_os_type.value,'Unknown OS')) like 'UNKN%' THEN 'Unknown OS'
		ELSE coalesce(enum_os_type.value,'Unknown OS')
	     END) as os_name,
	   history_datetime,
      	   COUNT(DISTINCT v3_0_vm_configuration_view.vm_id) AS vm_count
      FROM v3_0_vm_daily_history_view
	INNER JOIN v3_0_vm_configuration_view
  	ON (v3_0_vm_configuration_view.history_id = v3_0_vm_daily_history_view.vm_configuration_version)
		INNER JOIN v3_0_enum_translator_view enum_os_type
		ON (enum_os_type.enum_key = v3_0_vm_configuration_view.operating_system AND enum_os_type.enum_type = 'OS_TYPE')
	INNER JOIN v3_0_vm_configuration_view a
  	ON (a.vm_id = v3_0_vm_daily_history_view.vm_id)
      WHERE v3_0_vm_daily_history_view.vm_status = 1
	  AND v3_0_vm_configuration_view.cluster_id in (SELECT cluster_id
					       FROM v3_0_cluster_configuration_view
					       Where datacenter_id = cast($P{P_DataCenter_ID} as uuid))
  	  AND v3_0_vm_configuration_view.cluster_id = CASE $P{P_Cluster_ID}
						WHEN NULL THEN v3_0_vm_configuration_view.cluster_id
						WHEN '11111111-1111-1111-1111-111111111111' THEN v3_0_vm_configuration_view.cluster_id
						ELSE cast($P{P_Cluster_ID} as uuid)
					     END
	  AND a.history_id in (SELECT max(b.history_id)
			   FROM v3_0_vm_configuration_view b
			   GROUP BY b.vm_id)
  	  AND history_datetime >= cast($P{P_Start_Date} as timestamp)
	  AND history_datetime < cast($P{P_End_Date} as date) + interval '1 day'
	  AND CASE
		WHEN $P{Active_VMs} like 'AND%' THEN a.delete_date IS NULL
		ELSE a.delete_date IS NULL or a.delete_date IS NOT NULL
	      END
      GROUP BY (CASE
		WHEN UPPER(coalesce(enum_os_type.value,'Unknown OS')) like 'UNKN%' THEN 'Unknown OS'
		ELSE coalesce(enum_os_type.value,'Unknown OS')
	     END),	 history_datetime) a right outer join calendar b on (history_datetime = b.the_date)
where the_date >= cast($P{P_Start_Date} as date)
      AND the_date < cast($P{P_End_Date} as date) + interval '1 day'
order by the_date]]>
	</queryString>
	<field name="the_date" class="java.sql.Date"/>
	<field name="os_name" class="java.lang.String"/>
	<field name="vm_count" class="java.lang.Long"/>
	<variable name="Date_group" class="java.lang.Integer" incrementType="Group" incrementGroup="Date" calculation="DistinctCount">
		<variableExpression><![CDATA[$F{the_date}]]></variableExpression>
	</variable>
	<group name="Date" keepTogether="true">
		<groupExpression><![CDATA[$F{the_date}]]></groupExpression>
	</group>
	<group name="count_change">
		<groupExpression><![CDATA[$F{vm_count}]]></groupExpression>
	</group>
	<title>
		<band height="240" splitType="Stretch">
			<timeSeriesChart>
				<chart evaluationTime="Report" hyperlinkType="ReportExecution" hyperlinkTarget="Blank" customizerClass="com.ovirt.reports.jasper.TimelineChartCustomizer" theme="ReportsLineBarChartTheme">
					<reportElement mode="Opaque" x="0" y="0" width="540" height="235"/>
					<box>
						<pen lineWidth="1.0" lineColor="#3C617F"/>
						<topPen lineWidth="1.0" lineColor="#3C617F"/>
						<leftPen lineWidth="2.0" lineColor="#3C617F"/>
						<bottomPen lineWidth="1.0" lineColor="#3C617F"/>
						<rightPen lineWidth="1.0" lineColor="#3C617F"/>
					</box>
					<chartTitle>
						<titleExpression><![CDATA[$R{br18a.chart.active.vms.os}]]></titleExpression>
					</chartTitle>
					<chartSubtitle/>
					<chartLegend position="Bottom"/>
					<hyperlinkParameter name="_report">
						<hyperlinkParameterExpression><![CDATA["/Reports/Executive/active_vms_by_os_br18"]]></hyperlinkParameterExpression>
					</hyperlinkParameter>
					<hyperlinkParameter name="Active_VMs">
						<hyperlinkParameterExpression><![CDATA[$P{Active_VMs}]]></hyperlinkParameterExpression>
					</hyperlinkParameter>
					<hyperlinkParameter name="P_DataCenter_ID">
						<hyperlinkParameterExpression><![CDATA[$P{P_DataCenter_ID}]]></hyperlinkParameterExpression>
					</hyperlinkParameter>
					<hyperlinkParameter name="P_Cluster_ID">
						<hyperlinkParameterExpression><![CDATA[$P{P_Cluster_ID}]]></hyperlinkParameterExpression>
					</hyperlinkParameter>
					<hyperlinkParameter name="P_Period">
						<hyperlinkParameterExpression><![CDATA[$P{P_Period}]]></hyperlinkParameterExpression>
					</hyperlinkParameter>
					<hyperlinkParameter name="P_Dates">
						<hyperlinkParameterExpression><![CDATA[$P{P_Dates}]]></hyperlinkParameterExpression>
					</hyperlinkParameter>
					<hyperlinkParameter name="P_Start_Date">
						<hyperlinkParameterExpression><![CDATA[$P{P_Start_Date}]]></hyperlinkParameterExpression>
					</hyperlinkParameter>
					<hyperlinkParameter name="P_End_Date">
						<hyperlinkParameterExpression><![CDATA[$P{P_End_Date}]]></hyperlinkParameterExpression>
					</hyperlinkParameter>
				</chart>
				<timeSeriesDataset>
					<timeSeries>
						<seriesExpression><![CDATA[$F{os_name}]]></seriesExpression>
						<timePeriodExpression><![CDATA[$F{the_date}]]></timePeriodExpression>
						<valueExpression><![CDATA[$F{vm_count}]]></valueExpression>
						<itemHyperlink>
							<hyperlinkTooltipExpression><![CDATA[$F{os_name} + ", " + $F{vm_count}.toString()]]></hyperlinkTooltipExpression>
						</itemHyperlink>
					</timeSeries>
				</timeSeriesDataset>
				<timeSeriesPlot isShowLines="true" isShowShapes="false">
					<plot/>
					<timeAxisLabelExpression><![CDATA[$R{axis.date}]]></timeAxisLabelExpression>
					<valueAxisLabelExpression><![CDATA[$R{axis.number.of.vms}]]></valueAxisLabelExpression>
				</timeSeriesPlot>
			</timeSeriesChart>
		</band>
	</title>
	<columnHeader>
		<band height="20">
			<frame>
				<reportElement mode="Opaque" x="0" y="0" width="540" height="20" backcolor="#D8E2FF"/>
				<textField>
					<reportElement x="3" y="0" width="100" height="20"/>
					<textElement verticalAlignment="Middle" markup="none">
						<font fontName="DejaVu Sans" size="11" isBold="true"/>
					</textElement>
					<textFieldExpression><![CDATA[$R{br18a.table.date}]]></textFieldExpression>
				</textField>
				<textField>
					<reportElement x="109" y="0" width="299" height="20"/>
					<textElement verticalAlignment="Middle" markup="none">
						<font fontName="DejaVu Sans" size="11" isBold="true"/>
					</textElement>
					<textFieldExpression><![CDATA[$R{br18a.table.os.version}]]></textFieldExpression>
				</textField>
				<textField>
					<reportElement x="463" y="0" width="69" height="20"/>
					<textElement verticalAlignment="Middle" markup="none">
						<font fontName="DejaVu Sans" size="11" isBold="true"/>
					</textElement>
					<textFieldExpression><![CDATA[$R{br18a.table.number.of.vms}]]></textFieldExpression>
				</textField>
			</frame>
		</band>
	</columnHeader>
	<detail>
		<band height="19">
			<frame>
				<reportElement style="style1" x="0" y="0" width="540" height="19" isRemoveLineWhenBlank="true">
					<printWhenExpression><![CDATA[$F{vm_count} != null]]></printWhenExpression>
				</reportElement>
				<line>
					<reportElement x="0" y="0" width="540" height="1" forecolor="#D0DAE6">
						<printWhenExpression><![CDATA[$V{Date_COUNT} == 1]]></printWhenExpression>
					</reportElement>
				</line>
				<textField>
					<reportElement x="105" y="1" width="289" height="18">
						<printWhenExpression><![CDATA[$F{vm_count} != null]]></printWhenExpression>
					</reportElement>
					<textElement verticalAlignment="Middle">
						<font fontName="DejaVu Sans"/>
					</textElement>
					<textFieldExpression><![CDATA[$F{os_name}]]></textFieldExpression>
				</textField>
				<textField>
					<reportElement isPrintRepeatedValues="false" x="5" y="1" width="100" height="18">
						<printWhenExpression><![CDATA[$F{vm_count} != null]]></printWhenExpression>
					</reportElement>
					<textElement verticalAlignment="Middle">
						<font fontName="DejaVu Sans" size="11" isBold="true"/>
					</textElement>
					<textFieldExpression><![CDATA[DateFormat.getDateInstance(DateFormat.SHORT, $P{REPORT_LOCALE}).format($F{the_date})]]></textFieldExpression>
				</textField>
				<textField isBlankWhenNull="true">
					<reportElement x="409" y="1" width="82" height="18" isRemoveLineWhenBlank="true"/>
					<textElement textAlignment="Right" verticalAlignment="Middle">
						<font fontName="DejaVu Sans"/>
					</textElement>
					<textFieldExpression><![CDATA[$F{vm_count}]]></textFieldExpression>
				</textField>
			</frame>
		</band>
	</detail>
</jasperReport>
